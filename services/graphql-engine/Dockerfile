FROM hasura/graphql-engine:v1.0.0-alpha38.cli-migrations

ARG AUTH_ALGORITHM=RS256
ENV AUTH_ALGORITHM $AUTH_ALGORITHM

ARG HASURA_GRAPHQL_ENABLE_TELEMETRY=false
ENV HASURA_GRAPHQL_ENABLE_TELEMETRY $HASURA_GRAPHQL_ENABLE_TELEMETRY

ARG HASURA_GRAPHQL_ENABLE_CONSOLE=false
ENV HASURA_GRAPHQL_ENABLE_CONSOLE $HASURA_GRAPHQL_ENABLE_CONSOLE

ARG HASURA_GRAPHQL_SERVER_PORT=3000
ENV HASURA_GRAPHQL_SERVER_PORT $HASURA_GRAPHQL_SERVER_PORT

ENV HASURA_GRAPHQL_ADMIN_SECRET $HASURA_GRAPHQL_ADMIN_SECRET

ARG HASURA_GRAPHQL_JWT_SECRET='{ "type": "RS256", "jwk_url": "http://authentication:3000/jwks"}'
ENV HASURA_GRAPHQL_JWT_SECRET $HASURA_GRAPHQL_JWT_SECRET

ARG HASURA_GRAPHQL_DATABASE_URL=postgres://postgres:@postgres:5432/postgres
ENV HASURA_GRAPHQL_DATABASE_URL $HASURA_GRAPHQL_DATABASE_URL

ARG HASURA_GRAPHQL_UNAUTHORIZED_ROLE='anonymous'
ENV HASURA_GRAPHQL_UNAUTHORIZED_ROLE $HASURA_GRAPHQL_UNAUTHORIZED_ROLE

COPY migrations /opt/hasura-migrations
COPY load-env-and-migrate.sh /bin/load-env-and-migrate.sh
ENTRYPOINT ["load-env-and-migrate.sh"]

HEALTHCHECK  --interval=30s --timeout=3s CMD wget --quiet --spider http://localhost:${HASURA_GRAPHQL_SERVER_PORT:-8080}/v1/version || exit 1

CMD ["graphql-engine", "serve"]
