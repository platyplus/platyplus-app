version: '3.1'
services:
  reverse-proxy:
    command:
      - '--docker.watch'
  authentication:
    environment:
      HASURA_URL: 'http://graphql-engine:80/v1alpha1/graphql'
      NODE_ENV: production
      PORT: 80
      HASURA_GRAPHQL_ACCESS_KEY_FILE: /run/secrets/hasura_secret_key
      PUBLIC_KEY_FILE: /run/secrets/authentication_public_key
      PRIVATE_KEY_FILE: /run/secrets/authentication_private_key
    secrets:
      - hasura_secret_key
      - authentication_public_key
      - authentication_private_key
    deploy:
      replicas: 1
  graphql-engine:
    labels:
      - 'traefik.port=80'
    environment:
      HASURA_GRAPHQL_SERVER_PORT: 80
      HASURA_GRAPHQL_ACCESS_KEY_FILE: /run/secrets/hasura_secret_key
      AUTH_PUBLIC_KEY_FILE: /run/secrets/authentication_public_key
    secrets:
      - hasura_secret_key
      - authentication_public_key
    deploy:
      replicas: 1
  synchronization-hook:
    environment:
      NODE_ENV: production
      PORT: 80
      HASURA_GRAPHQL_ACCESS_KEY_FILE: /run/secrets/hasura_secret_key
    secrets:
      - hasura_secret_key
    deploy:
      replicas: 1
secrets:
  hasura_secret_key:
    external: true
  authentication_public_key:
    external: true
  authentication_private_key:
    external: true
